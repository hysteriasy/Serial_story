<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä½œå“ - æ¡‘æ¢“</title>
    
    <!-- åŸºç¡€æ ·å¼ -->
    <link rel="stylesheet" href="css/style.css?v=20240807">
    <link rel="stylesheet" href="css/ios-compatibility.css?v=20240810">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- é¡µé¢ç‰¹å®šæ ·å¼ -->
    <style>
        /* æˆ‘çš„ä½œå“é¡µé¢ç‰¹å®šæ ·å¼ */
        .my-works-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 100px 0 60px 0;
            text-align: center;
            min-height: 50vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .my-works-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .works-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
            backdrop-filter: blur(10px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .works-content {
            padding: 60px 0;
            background: #f8f9fa;
        }
        
        .works-section {
            margin-bottom: 50px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007bff;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #333;
            margin: 0;
        }
        
        .section-count {
            background: #007bff;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .works-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .work-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }
        
        .work-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .work-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .work-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin: 0;
            flex: 1;
            margin-right: 10px;
        }
        
        .work-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        
        .btn-view {
            background: #007bff;
            color: white;
        }
        
        .btn-edit {
            background: #28a745;
            color: white;
        }
        
        .btn-permissions {
            background: #ffc107;
            color: #333;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .action-btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }
        
        .work-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            font-size: 0.9rem;
            color: #666;
        }
        
        .work-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .work-visibility {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .visibility-public {
            background: #d4edda;
            color: #155724;
        }
        
        .visibility-private {
            background: #f8d7da;
            color: #721c24;
        }
        
        .visibility-friends {
            background: #fff3cd;
            color: #856404;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #333;
        }
        
        .empty-description {
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .login-required {
            text-align: center;
            padding: 100px 20px;
            background: white;
            margin: 40px auto;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 600px;
        }
        
        .login-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #007bff;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .my-works-hero {
                padding: 80px 0 40px 0;
                min-height: 40vh;
            }
            
            .hero-title {
                font-size: 2.5rem;
            }
            
            .works-stats {
                gap: 15px;
            }
            
            .stat-item {
                min-width: 100px;
                padding: 15px;
            }
            
            .works-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .work-actions {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .action-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- é¡µçœ‰å°†é€šè¿‡ç»„ä»¶åŠ¨æ€æ’å…¥ -->
    
    <!-- ä¸»è¦å†…å®¹ -->
    <main>
        <!-- è‹±é›„åŒº -->
        <section class="my-works-hero">
            <div class="my-works-container">
                <h1 class="hero-title">æˆ‘çš„ä½œå“</h1>
                <p class="hero-description">ç®¡ç†å’Œå±•ç¤ºæ‚¨çš„åˆ›ä½œæˆæœ</p>
                
                <!-- ä½œå“ç»Ÿè®¡ -->
                <div class="works-stats" id="worksStats">
                    <div class="stat-item">
                        <span class="stat-number" id="totalWorksCount">0</span>
                        <span class="stat-label">æ€»ä½œå“</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="publicWorksCount">0</span>
                        <span class="stat-label">å…¬å¼€ä½œå“</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="privateWorksCount">0</span>
                        <span class="stat-label">ç§æœ‰ä½œå“</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="categoriesCount">0</span>
                        <span class="stat-label">åˆ†ç±»æ•°é‡</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- ä½œå“å†…å®¹åŒº -->
        <section class="works-content">
            <div class="my-works-container">
                <!-- ç™»å½•æç¤ºåŒºåŸŸ -->
                <div id="loginRequired" class="login-required" style="display: none;">
                    <div class="login-icon">ğŸ”</div>
                    <h2>éœ€è¦ç™»å½•</h2>
                    <p>è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„ä½œå“</p>
                    <button class="btn btn-primary" onclick="showLoginModal()">ç«‹å³ç™»å½•</button>
                </div>

                <!-- ä½œå“å±•ç¤ºåŒºåŸŸ -->
                <div id="worksDisplay" style="display: none;">
                    <!-- ç”Ÿæ´»éšç¬” -->
                    <div class="works-section" id="essaysSection">
                        <div class="section-header">
                            <h2 class="section-title">ğŸ“ ç”Ÿæ´»éšç¬”</h2>
                            <span class="section-count" id="essaysCount">0</span>
                        </div>
                        <div class="works-grid" id="essaysGrid">
                            <!-- ä½œå“å¡ç‰‡å°†åŠ¨æ€æ’å…¥ -->
                        </div>
                    </div>

                    <!-- è¯—æ­Œåˆ›ä½œ -->
                    <div class="works-section" id="poetrySection">
                        <div class="section-header">
                            <h2 class="section-title">ğŸŒ¸ è¯—æ­Œåˆ›ä½œ</h2>
                            <span class="section-count" id="poetryCount">0</span>
                        </div>
                        <div class="works-grid" id="poetryGrid">
                            <!-- ä½œå“å¡ç‰‡å°†åŠ¨æ€æ’å…¥ -->
                        </div>
                    </div>

                    <!-- å°è¯´è¿è½½ -->
                    <div class="works-section" id="novelsSection">
                        <div class="section-header">
                            <h2 class="section-title">ğŸ“š å°è¯´è¿è½½</h2>
                            <span class="section-count" id="novelsCount">0</span>
                        </div>
                        <div class="works-grid" id="novelsGrid">
                            <!-- ä½œå“å¡ç‰‡å°†åŠ¨æ€æ’å…¥ -->
                        </div>
                    </div>

                    <!-- ç»˜ç”»ä½œå“ -->
                    <div class="works-section" id="artworksSection">
                        <div class="section-header">
                            <h2 class="section-title">ğŸ¨ ç»˜ç”»ä½œå“</h2>
                            <span class="section-count" id="artworksCount">0</span>
                        </div>
                        <div class="works-grid" id="artworksGrid">
                            <!-- ä½œå“å¡ç‰‡å°†åŠ¨æ€æ’å…¥ -->
                        </div>
                    </div>

                    <!-- éŸ³ä¹ä½œå“ -->
                    <div class="works-section" id="musicSection">
                        <div class="section-header">
                            <h2 class="section-title">ğŸµ éŸ³ä¹ä½œå“</h2>
                            <span class="section-count" id="musicCount">0</span>
                        </div>
                        <div class="works-grid" id="musicGrid">
                            <!-- ä½œå“å¡ç‰‡å°†åŠ¨æ€æ’å…¥ -->
                        </div>
                    </div>

                    <!-- è§†é¢‘ä½œå“ -->
                    <div class="works-section" id="videosSection">
                        <div class="section-header">
                            <h2 class="section-title">ğŸ¬ è§†é¢‘ä½œå“</h2>
                            <span class="section-count" id="videosCount">0</span>
                        </div>
                        <div class="works-grid" id="videosGrid">
                            <!-- ä½œå“å¡ç‰‡å°†åŠ¨æ€æ’å…¥ -->
                        </div>
                    </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div id="emptyState" class="empty-state" style="display: none;">
                        <div class="empty-icon">ğŸ“</div>
                        <h3 class="empty-title">è¿˜æ²¡æœ‰ä½œå“</h3>
                        <p class="empty-description">
                            æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•ä½œå“ã€‚<br>
                            å¼€å§‹åˆ›ä½œï¼Œåˆ†äº«æ‚¨çš„ç²¾å½©å†…å®¹å§ï¼
                        </p>
                        <button class="btn btn-primary" onclick="window.location.href='upload.html'">
                            å¼€å§‹åˆ›ä½œ
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- é¡µè„šå°†é€šè¿‡ç»„ä»¶åŠ¨æ€æ’å…¥ -->

    <!-- ç¼–è¾‘ä½œå“æ¨¡æ€æ¡† -->
    <div id="editWorkModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘ä½œå“</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editWorkForm">
                    <div class="form-group">
                        <label for="editTitle">æ ‡é¢˜</label>
                        <input type="text" id="editTitle" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="editDescription">æè¿°</label>
                        <textarea id="editDescription" name="description" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editContent">å†…å®¹</label>
                        <textarea id="editContent" name="content" rows="10"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveWorkEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æƒé™è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="permissionsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æƒé™è®¾ç½®</h3>
                <span class="close" onclick="closePermissionsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å¯è§æ€§è®¾ç½®</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="visibility" value="public">
                            <span>ğŸŒ å…¬å¼€ - æ‰€æœ‰äººå¯è§</span>
                        </label>
                        <label>
                            <input type="radio" name="visibility" value="friends">
                            <span>ğŸ‘¥ æœ‹å‹ - ä»…æœ‹å‹å¯è§</span>
                        </label>
                        <label>
                            <input type="radio" name="visibility" value="private">
                            <span>ğŸ”’ ç§æœ‰ - ä»…è‡ªå·±å¯è§</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="allowComments">
                        å…è®¸è¯„è®º
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="allowDownload">
                        å…è®¸ä¸‹è½½
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePermissionsModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="savePermissions()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- JavaScript ä¾èµ– -->
    <script src="js/auth.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/header-footer.js"></script>
    <script src="js/permissions-manager.js"></script>

    <!-- æˆ‘çš„ä½œå“é¡µé¢è„šæœ¬ -->
    <script>
        /**
         * æˆ‘çš„ä½œå“é¡µé¢ç®¡ç†å™¨
         */
        class MyWorksManager {
            constructor() {
                this.currentUser = null;
                this.userWorks = [];
                this.worksByCategory = {};
                this.currentEditingWork = null;
                this.currentPermissionsWork = null;

                // åˆ†ç±»é…ç½®
                this.categories = {
                    essays: { name: 'ç”Ÿæ´»éšç¬”', icon: 'ğŸ“' },
                    poetry: { name: 'è¯—æ­Œåˆ›ä½œ', icon: 'ğŸŒ¸' },
                    novels: { name: 'å°è¯´è¿è½½', icon: 'ğŸ“š' },
                    artworks: { name: 'ç»˜ç”»ä½œå“', icon: 'ğŸ¨' },
                    music: { name: 'éŸ³ä¹ä½œå“', icon: 'ğŸµ' },
                    videos: { name: 'è§†é¢‘ä½œå“', icon: 'ğŸ¬' }
                };
            }

            // åˆå§‹åŒ–é¡µé¢
            async init() {
                console.log('ğŸš€ åˆå§‹åŒ–æˆ‘çš„ä½œå“é¡µé¢...');

                // åˆå§‹åŒ–é¡µçœ‰é¡µè„šç»„ä»¶
                await this.initHeaderFooter();

                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                this.checkAuthStatus();

                // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
                this.setupAuthListeners();

                // ç»‘å®šäº‹ä»¶
                this.bindEvents();

                console.log('âœ… æˆ‘çš„ä½œå“é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            }

            // åˆå§‹åŒ–é¡µçœ‰é¡µè„šç»„ä»¶
            async initHeaderFooter() {
                try {
                    if (typeof HeaderFooterComponent !== 'undefined') {
                        window.headerFooterComponent = new HeaderFooterComponent();
                        await window.headerFooterComponent.init();
                        console.log('âœ… é¡µçœ‰é¡µè„šç»„ä»¶åˆå§‹åŒ–æˆåŠŸ');
                    } else {
                        console.warn('âš ï¸ HeaderFooterComponent æœªå®šä¹‰ï¼Œè·³è¿‡é¡µçœ‰é¡µè„šåˆå§‹åŒ–');
                    }
                } catch (error) {
                    console.error('âŒ é¡µçœ‰é¡µè„šç»„ä»¶åˆå§‹åŒ–å¤±è´¥:', error);
                }
            }

            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            checkAuthStatus() {
                console.log('ğŸ” æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€...');

                if (auth && auth.currentUser) {
                    this.currentUser = auth.currentUser;
                    console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', this.currentUser.username);
                    this.showWorksContent();
                    this.loadUserWorks();
                } else {
                    console.log('âŒ ç”¨æˆ·æœªç™»å½•');
                    this.showLoginRequired();
                }
            }

            // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬å™¨
            setupAuthListeners() {
                // ç›‘å¬å…¨å±€è®¤è¯çŠ¶æ€æ›´æ–°äº‹ä»¶
                window.addEventListener('authStateUpdate', (event) => {
                    console.log('ğŸ“¢ æ”¶åˆ°è®¤è¯çŠ¶æ€æ›´æ–°äº‹ä»¶:', event.detail);

                    if (event.detail.isLoggedIn && event.detail.user) {
                        this.currentUser = event.detail.user;
                        this.showWorksContent();
                        this.loadUserWorks();
                    } else {
                        this.currentUser = null;
                        this.showLoginRequired();
                    }
                });

                // å®šæœŸæ£€æŸ¥è®¤è¯çŠ¶æ€ï¼ˆé˜²æ­¢çŠ¶æ€ä¸åŒæ­¥ï¼‰
                setInterval(() => {
                    if (auth && auth.currentUser && !this.currentUser) {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°ç™»å½•çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°é¡µé¢');
                        this.checkAuthStatus();
                    } else if (!auth?.currentUser && this.currentUser) {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°ç™»å‡ºçŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°é¡µé¢');
                        this.checkAuthStatus();
                    }
                }, 2000);
            }

            // æ˜¾ç¤ºç™»å½•è¦æ±‚
            showLoginRequired() {
                document.getElementById('loginRequired').style.display = 'block';
                document.getElementById('worksDisplay').style.display = 'none';

                // éšè—ç»Ÿè®¡æ•°æ®
                this.updateStats(0, 0, 0, 0);
            }

            // æ˜¾ç¤ºä½œå“å†…å®¹
            showWorksContent() {
                document.getElementById('loginRequired').style.display = 'none';
                document.getElementById('worksDisplay').style.display = 'block';
            }

            // åŠ è½½ç”¨æˆ·ä½œå“
            async loadUserWorks() {
                if (!this.currentUser) {
                    console.warn('âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•åŠ è½½ä½œå“');
                    return;
                }

                console.log('ğŸ“š å¼€å§‹åŠ è½½ç”¨æˆ·ä½œå“...');

                try {
                    this.userWorks = [];
                    this.worksByCategory = {};

                    // åˆå§‹åŒ–åˆ†ç±»
                    Object.keys(this.categories).forEach(category => {
                        this.worksByCategory[category] = [];
                    });

                    // ä»localStorageåŠ è½½ä½œå“
                    await this.loadWorksFromLocalStorage();

                    // å¦‚æœæ”¯æŒGitHub APIï¼Œä¹Ÿä»GitHubåŠ è½½
                    if (window.dataManager && window.dataManager.shouldUseGitHubStorage()) {
                        await this.loadWorksFromGitHub();
                    }

                    // æ¸²æŸ“ä½œå“
                    this.renderAllWorks();

                    // æ›´æ–°ç»Ÿè®¡
                    this.updateStatistics();

                    console.log('âœ… ç”¨æˆ·ä½œå“åŠ è½½å®Œæˆï¼Œå…±', this.userWorks.length, 'ä¸ªä½œå“');

                } catch (error) {
                    console.error('âŒ åŠ è½½ç”¨æˆ·ä½œå“å¤±è´¥:', error);
                    this.showErrorMessage('åŠ è½½ä½œå“å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }

            // ä»localStorageåŠ è½½ä½œå“
            async loadWorksFromLocalStorage() {
                console.log('ğŸ“‚ ä»localStorageåŠ è½½ä½œå“...');

                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('work_')) {
                        try {
                            const workData = localStorage.getItem(key);
                            if (workData) {
                                const work = JSON.parse(workData);

                                // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·çš„ä½œå“
                                if (work.uploadedBy === this.currentUser.username ||
                                    work.author === this.currentUser.username) {

                                    // æ·»åŠ å·¥ä½œID
                                    work.workId = key.replace('work_', '');

                                    // ç¡®ä¿æœ‰æƒé™è®¾ç½®
                                    if (!work.permissions) {
                                        work.permissions = this.createDefaultPermissions(work);
                                    }

                                    this.userWorks.push(work);

                                    // æŒ‰åˆ†ç±»ç»„ç»‡
                                    const category = this.getCategoryFromWork(work);
                                    if (category && this.worksByCategory[category]) {
                                        this.worksByCategory[category].push(work);
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('è§£æä½œå“æ•°æ®å¤±è´¥:', key, error);
                        }
                    }
                }

                console.log('âœ… localStorageä½œå“åŠ è½½å®Œæˆï¼Œå…±', this.userWorks.length, 'ä¸ªä½œå“');
            }

            // ä»GitHubåŠ è½½ä½œå“ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            async loadWorksFromGitHub() {
                console.log('ğŸŒ ä»GitHubåŠ è½½ä½œå“...');

                try {
                    if (window.dataManager) {
                        // åŠ è½½ç”¨æˆ·ä½œå“åˆ—è¡¨
                        const userWorksList = await window.dataManager.loadUserWorksList(this.currentUser.username);

                        if (userWorksList && userWorksList.length > 0) {
                            for (const workId of userWorksList) {
                                try {
                                    const workData = await window.dataManager.loadWorkData(workId);
                                    if (workData && !this.userWorks.find(w => w.workId === workId)) {
                                        workData.workId = workId;
                                        this.userWorks.push(workData);

                                        // æŒ‰åˆ†ç±»ç»„ç»‡
                                        const category = this.getCategoryFromWork(workData);
                                        if (category && this.worksByCategory[category]) {
                                            this.worksByCategory[category].push(workData);
                                        }
                                    }
                                } catch (error) {
                                    console.warn('åŠ è½½GitHubä½œå“å¤±è´¥:', workId, error);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.warn('GitHubä½œå“åŠ è½½å¤±è´¥:', error);
                }
            }

            // è·å–ä½œå“åˆ†ç±»
            getCategoryFromWork(work) {
                // ä¼˜å…ˆä½¿ç”¨mainCategory
                if (work.mainCategory && this.categories[work.mainCategory]) {
                    return work.mainCategory;
                }

                // æ ¹æ®categoryNameæ¨æ–­
                if (work.categoryName) {
                    const categoryName = work.categoryName.toLowerCase();
                    for (const [key, config] of Object.entries(this.categories)) {
                        if (categoryName.includes(config.name) || categoryName.includes(key)) {
                            return key;
                        }
                    }
                }

                // æ ¹æ®æ–‡ä»¶ç±»å‹æ¨æ–­
                if (work.fileType) {
                    const fileType = work.fileType.toLowerCase();
                    if (fileType.includes('image')) return 'artworks';
                    if (fileType.includes('audio')) return 'music';
                    if (fileType.includes('video')) return 'videos';
                }

                // é»˜è®¤åˆ†ç±»
                return 'essays';
            }

            // åˆ›å»ºé»˜è®¤æƒé™è®¾ç½®
            createDefaultPermissions(work) {
                return {
                    visibility: 'public',
                    isPublic: true,
                    allowComments: true,
                    allowDownload: false,
                    requiredRole: 'guest',
                    createdAt: new Date().toISOString(),
                    createdBy: this.currentUser.username
                };
            }

            // æ¸²æŸ“æ‰€æœ‰ä½œå“
            renderAllWorks() {
                console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“ä½œå“...');

                let hasAnyWorks = false;

                // æ¸²æŸ“å„ä¸ªåˆ†ç±»
                Object.keys(this.categories).forEach(category => {
                    const works = this.worksByCategory[category] || [];
                    this.renderCategoryWorks(category, works);

                    if (works.length > 0) {
                        hasAnyWorks = true;
                    }
                });

                // æ˜¾ç¤ºæˆ–éšè—ç©ºçŠ¶æ€
                document.getElementById('emptyState').style.display = hasAnyWorks ? 'none' : 'block';
            }

            // æ¸²æŸ“åˆ†ç±»ä½œå“
            renderCategoryWorks(category, works) {
                const section = document.getElementById(`${category}Section`);
                const grid = document.getElementById(`${category}Grid`);
                const count = document.getElementById(`${category}Count`);

                if (!section || !grid || !count) {
                    console.warn('åˆ†ç±»å…ƒç´ ä¸å­˜åœ¨:', category);
                    return;
                }

                // æ›´æ–°è®¡æ•°
                count.textContent = works.length;

                // æ˜¾ç¤ºæˆ–éšè—åˆ†ç±»
                if (works.length === 0) {
                    section.style.display = 'none';
                    return;
                }

                section.style.display = 'block';

                // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                works.sort((a, b) => new Date(b.uploadTime || b.createdAt) - new Date(a.uploadTime || a.createdAt));

                // æ¸²æŸ“ä½œå“å¡ç‰‡
                grid.innerHTML = works.map(work => this.createWorkCard(work)).join('');
            }

            // åˆ›å»ºä½œå“å¡ç‰‡
            createWorkCard(work) {
                const date = this.formatDate(work.uploadTime || work.createdAt);
                const visibility = this.getVisibilityInfo(work.permissions);
                const description = work.description || work.content || '';
                const truncatedDesc = description.length > 100 ? description.substring(0, 100) + '...' : description;

                return `
                    <div class="work-card">
                        <div class="work-header">
                            <h3 class="work-title">${this.escapeHtml(work.title)}</h3>
                            <div class="work-actions">
                                <button class="action-btn btn-view" onclick="myWorksManager.viewWork('${work.workId}')" title="æŸ¥çœ‹">
                                    ğŸ‘ï¸
                                </button>
                                <button class="action-btn btn-edit" onclick="myWorksManager.editWork('${work.workId}')" title="ç¼–è¾‘">
                                    âœï¸
                                </button>
                                <button class="action-btn btn-permissions" onclick="myWorksManager.editPermissions('${work.workId}')" title="æƒé™è®¾ç½®">
                                    ğŸ”’
                                </button>
                                <button class="action-btn btn-delete" onclick="myWorksManager.deleteWork('${work.workId}')" title="åˆ é™¤">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>

                        ${truncatedDesc ? `<p class="work-description">${this.escapeHtml(truncatedDesc)}</p>` : ''}

                        <div class="work-meta">
                            <div class="work-date">
                                <span>ğŸ“…</span>
                                <span>${date}</span>
                            </div>
                            <div class="work-visibility ${visibility.class}">
                                <span>${visibility.icon}</span>
                                <span>${visibility.text}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // è·å–å¯è§æ€§ä¿¡æ¯
            getVisibilityInfo(permissions) {
                if (!permissions) {
                    return { icon: 'ğŸ”’', text: 'ç§æœ‰', class: 'visibility-private' };
                }

                switch (permissions.visibility) {
                    case 'public':
                        return { icon: 'ğŸŒ', text: 'å…¬å¼€', class: 'visibility-public' };
                    case 'friends':
                        return { icon: 'ğŸ‘¥', text: 'æœ‹å‹', class: 'visibility-friends' };
                    case 'private':
                    default:
                        return { icon: 'ğŸ”’', text: 'ç§æœ‰', class: 'visibility-private' };
                }
            }

            // æ ¼å¼åŒ–æ—¥æœŸ
            formatDate(dateString) {
                if (!dateString) return 'æœªçŸ¥æ—¶é—´';

                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (error) {
                    return 'æœªçŸ¥æ—¶é—´';
                }
            }

            // HTMLè½¬ä¹‰
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStatistics() {
                const totalWorks = this.userWorks.length;
                const publicWorks = this.userWorks.filter(work =>
                    work.permissions && work.permissions.visibility === 'public'
                ).length;
                const privateWorks = this.userWorks.filter(work =>
                    !work.permissions || work.permissions.visibility === 'private'
                ).length;
                const categoriesWithWorks = Object.values(this.worksByCategory).filter(works => works.length > 0).length;

                this.updateStats(totalWorks, publicWorks, privateWorks, categoriesWithWorks);
            }

            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            updateStats(total, publicCount, privateCount, categories) {
                document.getElementById('totalWorksCount').textContent = total;
                document.getElementById('publicWorksCount').textContent = publicCount;
                document.getElementById('privateWorksCount').textContent = privateCount;
                document.getElementById('categoriesCount').textContent = categories;
            }

            // æŸ¥çœ‹ä½œå“
            async viewWork(workId) {
                console.log('ğŸ‘ï¸ æŸ¥çœ‹ä½œå“:', workId);

                const work = this.userWorks.find(w => w.workId === workId);
                if (!work) {
                    this.showErrorMessage('ä½œå“ä¸å­˜åœ¨');
                    return;
                }

                // æ ¹æ®ä½œå“ç±»å‹è·³è½¬åˆ°ç›¸åº”é¡µé¢
                const category = this.getCategoryFromWork(work);
                let targetPage = '';

                switch (category) {
                    case 'essays':
                        targetPage = 'essays.html';
                        break;
                    case 'poetry':
                        targetPage = 'poetry.html';
                        break;
                    case 'novels':
                        targetPage = 'novels.html';
                        break;
                    case 'artworks':
                        targetPage = 'artworks.html';
                        break;
                    case 'music':
                        targetPage = 'music.html';
                        break;
                    case 'videos':
                        targetPage = 'videos.html';
                        break;
                    default:
                        targetPage = 'index.html';
                }

                // è·³è½¬åˆ°å¯¹åº”é¡µé¢
                window.location.href = targetPage;
            }

            // ç¼–è¾‘ä½œå“
            async editWork(workId) {
                console.log('âœï¸ ç¼–è¾‘ä½œå“:', workId);

                const work = this.userWorks.find(w => w.workId === workId);
                if (!work) {
                    this.showErrorMessage('ä½œå“ä¸å­˜åœ¨');
                    return;
                }

                this.currentEditingWork = work;

                // å¡«å……ç¼–è¾‘è¡¨å•
                document.getElementById('editTitle').value = work.title || '';
                document.getElementById('editDescription').value = work.description || '';
                document.getElementById('editContent').value = work.content || '';

                // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
                document.getElementById('editWorkModal').style.display = 'block';
            }

            // ç¼–è¾‘æƒé™
            async editPermissions(workId) {
                console.log('ğŸ”’ ç¼–è¾‘æƒé™:', workId);

                const work = this.userWorks.find(w => w.workId === workId);
                if (!work) {
                    this.showErrorMessage('ä½œå“ä¸å­˜åœ¨');
                    return;
                }

                this.currentPermissionsWork = work;

                // å¡«å……æƒé™è¡¨å•
                const permissions = work.permissions || this.createDefaultPermissions(work);

                // è®¾ç½®å¯è§æ€§é€‰é¡¹
                const visibilityRadios = document.querySelectorAll('input[name="visibility"]');
                visibilityRadios.forEach(radio => {
                    radio.checked = radio.value === permissions.visibility;
                });

                // è®¾ç½®å…¶ä»–é€‰é¡¹
                document.getElementById('allowComments').checked = permissions.allowComments !== false;
                document.getElementById('allowDownload').checked = permissions.allowDownload === true;

                // æ˜¾ç¤ºæƒé™æ¨¡æ€æ¡†
                document.getElementById('permissionsModal').style.display = 'block';
            }

            // åˆ é™¤ä½œå“
            async deleteWork(workId) {
                console.log('ğŸ—‘ï¸ åˆ é™¤ä½œå“:', workId);

                const work = this.userWorks.find(w => w.workId === workId);
                if (!work) {
                    this.showErrorMessage('ä½œå“ä¸å­˜åœ¨');
                    return;
                }

                // ç¡®è®¤åˆ é™¤
                const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤ä½œå“ã€Š${work.title}ã€‹å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
                if (!confirmed) {
                    return;
                }

                try {
                    // ä»localStorageåˆ é™¤
                    localStorage.removeItem(`work_${workId}`);

                    // å¦‚æœæ”¯æŒGitHub APIï¼Œä¹Ÿä»GitHubåˆ é™¤
                    if (window.dataManager && window.dataManager.shouldUseGitHubStorage()) {
                        try {
                            await window.dataManager.deleteWorkData(workId);
                        } catch (error) {
                            console.warn('GitHubåˆ é™¤å¤±è´¥:', error);
                        }
                    }

                    // ä»å†…å­˜ä¸­ç§»é™¤
                    this.userWorks = this.userWorks.filter(w => w.workId !== workId);

                    // ä»åˆ†ç±»ä¸­ç§»é™¤
                    Object.keys(this.worksByCategory).forEach(category => {
                        this.worksByCategory[category] = this.worksByCategory[category].filter(w => w.workId !== workId);
                    });

                    // é‡æ–°æ¸²æŸ“
                    this.renderAllWorks();
                    this.updateStatistics();

                    this.showSuccessMessage('ä½œå“åˆ é™¤æˆåŠŸï¼');

                } catch (error) {
                    console.error('åˆ é™¤ä½œå“å¤±è´¥:', error);
                    this.showErrorMessage('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                }
            }

            // ä¿å­˜ä½œå“ç¼–è¾‘
            async saveWorkEdit() {
                if (!this.currentEditingWork) {
                    this.showErrorMessage('æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„ä½œå“');
                    return;
                }

                try {
                    const title = document.getElementById('editTitle').value.trim();
                    const description = document.getElementById('editDescription').value.trim();
                    const content = document.getElementById('editContent').value.trim();

                    if (!title) {
                        this.showErrorMessage('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
                        return;
                    }

                    // æ›´æ–°ä½œå“æ•°æ®
                    this.currentEditingWork.title = title;
                    this.currentEditingWork.description = description;
                    this.currentEditingWork.content = content;
                    this.currentEditingWork.lastModified = new Date().toISOString();
                    this.currentEditingWork.modifiedBy = this.currentUser.username;

                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem(`work_${this.currentEditingWork.workId}`, JSON.stringify(this.currentEditingWork));

                    // å¦‚æœæ”¯æŒGitHub APIï¼Œä¹Ÿä¿å­˜åˆ°GitHub
                    if (window.dataManager && window.dataManager.shouldUseGitHubStorage()) {
                        try {
                            await window.dataManager.saveWorkData(this.currentEditingWork.workId, this.currentEditingWork);
                        } catch (error) {
                            console.warn('GitHubä¿å­˜å¤±è´¥:', error);
                        }
                    }

                    // é‡æ–°æ¸²æŸ“
                    this.renderAllWorks();

                    // å…³é—­æ¨¡æ€æ¡†
                    this.closeEditModal();

                    this.showSuccessMessage('ä½œå“æ›´æ–°æˆåŠŸï¼');

                } catch (error) {
                    console.error('ä¿å­˜ä½œå“ç¼–è¾‘å¤±è´¥:', error);
                    this.showErrorMessage('ä¿å­˜å¤±è´¥ï¼š' + error.message);
                }
            }

            // ä¿å­˜æƒé™è®¾ç½®
            async savePermissions() {
                if (!this.currentPermissionsWork) {
                    this.showErrorMessage('æ²¡æœ‰æ­£åœ¨ç¼–è¾‘æƒé™çš„ä½œå“');
                    return;
                }

                try {
                    const visibility = document.querySelector('input[name="visibility"]:checked')?.value || 'private';
                    const allowComments = document.getElementById('allowComments').checked;
                    const allowDownload = document.getElementById('allowDownload').checked;

                    // æ›´æ–°æƒé™è®¾ç½®
                    const newPermissions = {
                        ...this.currentPermissionsWork.permissions,
                        visibility: visibility,
                        isPublic: visibility === 'public',
                        allowComments: allowComments,
                        allowDownload: allowDownload,
                        lastModified: new Date().toISOString(),
                        modifiedBy: this.currentUser.username
                    };

                    this.currentPermissionsWork.permissions = newPermissions;

                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem(`work_${this.currentPermissionsWork.workId}`, JSON.stringify(this.currentPermissionsWork));

                    // å¦‚æœæ”¯æŒGitHub APIï¼Œä¹Ÿä¿å­˜åˆ°GitHub
                    if (window.dataManager && window.dataManager.shouldUseGitHubStorage()) {
                        try {
                            await window.dataManager.saveWorkData(this.currentPermissionsWork.workId, this.currentPermissionsWork);
                        } catch (error) {
                            console.warn('GitHubæƒé™ä¿å­˜å¤±è´¥:', error);
                        }
                    }

                    // é‡æ–°æ¸²æŸ“
                    this.renderAllWorks();
                    this.updateStatistics();

                    // å…³é—­æ¨¡æ€æ¡†
                    this.closePermissionsModal();

                    this.showSuccessMessage('æƒé™è®¾ç½®ä¿å­˜æˆåŠŸï¼');

                } catch (error) {
                    console.error('ä¿å­˜æƒé™è®¾ç½®å¤±è´¥:', error);
                    this.showErrorMessage('ä¿å­˜å¤±è´¥ï¼š' + error.message);
                }
            }

            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
                window.addEventListener('click', (event) => {
                    if (event.target.classList.contains('modal')) {
                        if (event.target.id === 'editWorkModal') {
                            this.closeEditModal();
                        } else if (event.target.id === 'permissionsModal') {
                            this.closePermissionsModal();
                        }
                    }
                });

                // ESCé”®å…³é—­æ¨¡æ€æ¡†
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        this.closeEditModal();
                        this.closePermissionsModal();
                    }
                });
            }

            // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
            closeEditModal() {
                document.getElementById('editWorkModal').style.display = 'none';
                this.currentEditingWork = null;
            }

            // å…³é—­æƒé™æ¨¡æ€æ¡†
            closePermissionsModal() {
                document.getElementById('permissionsModal').style.display = 'none';
                this.currentPermissionsWork = null;
            }

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccessMessage(message) {
                this.showMessage(message, 'success');
            }

            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            showErrorMessage(message) {
                this.showMessage(message, 'error');
            }

            // æ˜¾ç¤ºæ¶ˆæ¯
            showMessage(message, type = 'success') {
                // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-toast message-${type}`;
                messageDiv.textContent = message;

                // æ·»åŠ æ ·å¼
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    max-width: 300px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                    background: ${type === 'success' ? '#28a745' : '#dc3545'};
                `;

                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(messageDiv);

                // æ˜¾ç¤ºåŠ¨ç”»
                setTimeout(() => {
                    messageDiv.style.transform = 'translateX(0)';
                }, 100);

                // è‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    messageDiv.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // å…¨å±€å‡½æ•°ï¼ˆä¾›HTMLè°ƒç”¨ï¼‰
        function closeEditModal() {
            if (window.myWorksManager) {
                window.myWorksManager.closeEditModal();
            }
        }

        function closePermissionsModal() {
            if (window.myWorksManager) {
                window.myWorksManager.closePermissionsModal();
            }
        }

        function saveWorkEdit() {
            if (window.myWorksManager) {
                window.myWorksManager.saveWorkEdit();
            }
        }

        function savePermissions() {
            if (window.myWorksManager) {
                window.myWorksManager.savePermissions();
            }
        }

        function showLoginModal() {
            // è°ƒç”¨é¡µçœ‰ç»„ä»¶çš„ç™»å½•æ¨¡æ€æ¡†
            if (window.headerFooterComponent && typeof window.headerFooterComponent.showLoginModal === 'function') {
                window.headerFooterComponent.showLoginModal();
            } else if (typeof window.showLoginModal === 'function') {
                window.showLoginModal();
            } else {
                alert('ç™»å½•åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ“„ æˆ‘çš„ä½œå“é¡µé¢DOMåŠ è½½å®Œæˆ');

            // ç­‰å¾…è®¤è¯ç³»ç»ŸåŠ è½½
            let authLoadAttempts = 0;
            const maxAuthLoadAttempts = 50;

            const waitForAuth = () => {
                return new Promise((resolve) => {
                    const checkAuth = () => {
                        authLoadAttempts++;
                        if (typeof auth !== 'undefined' && auth) {
                            console.log('âœ… è®¤è¯ç³»ç»Ÿå·²åŠ è½½');
                            resolve();
                        } else if (authLoadAttempts < maxAuthLoadAttempts) {
                            setTimeout(checkAuth, 100);
                        } else {
                            console.warn('âš ï¸ è®¤è¯ç³»ç»ŸåŠ è½½è¶…æ—¶ï¼Œç»§ç»­åˆå§‹åŒ–');
                            resolve();
                        }
                    };
                    checkAuth();
                });
            };

            await waitForAuth();

            // åˆå§‹åŒ–æˆ‘çš„ä½œå“ç®¡ç†å™¨
            window.myWorksManager = new MyWorksManager();
            await window.myWorksManager.init();
        });
    </script>
</body>
</html>
