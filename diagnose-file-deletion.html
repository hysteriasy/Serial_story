<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件删除问题诊断工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnostic-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .diagnostic-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .diagnostic-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background-color: #4CAF50; }
        .status-warning { background-color: #FF9800; }
        .status-error { background-color: #F44336; }
        .log-output {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .file-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error-details {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            color: #721c24;
        }
        .success-details {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <h1>🔍 文件删除问题诊断工具</h1>
        <p>专门诊断文件ID: <strong>2025-08-16_work_work_1755320228871_7dh6r0uza</strong> 的删除问题</p>
        
        <div class="file-info">
            <strong>问题文件信息：</strong><br>
            文件ID: 2025-08-16_work_work_1755320228871_7dh6r0uza<br>
            作者: 1755320228871<br>
            问题: 多次删除无效，文件仍显示在列表中
        </div>
    </div>

    <!-- 文件存在性检查 -->
    <div class="diagnostic-container">
        <div class="diagnostic-section">
            <div class="diagnostic-title">📁 文件存在性检查</div>
            <div id="fileExistenceStatus">未检查</div>
            <button class="btn" onclick="checkFileExistence()">检查文件存在性</button>
            <div id="fileExistenceOutput" class="log-output" style="display: none;"></div>
        </div>
    </div>

    <!-- 权限检查 -->
    <div class="diagnostic-container">
        <div class="diagnostic-section">
            <div class="diagnostic-title">🔐 权限检查</div>
            <div id="permissionStatus">未检查</div>
            <button class="btn" onclick="checkPermissions()">检查删除权限</button>
            <div id="permissionOutput" class="log-output" style="display: none;"></div>
        </div>
    </div>

    <!-- 存储状态检查 -->
    <div class="diagnostic-container">
        <div class="diagnostic-section">
            <div class="diagnostic-title">💾 存储状态检查</div>
            <div id="storageStatus">未检查</div>
            <button class="btn" onclick="checkStorageStatus()">检查存储状态</button>
            <div id="storageOutput" class="log-output" style="display: none;"></div>
        </div>
    </div>

    <!-- 删除操作测试 -->
    <div class="diagnostic-container">
        <div class="diagnostic-section">
            <div class="diagnostic-title">🗑️ 删除操作测试</div>
            <div id="deletionStatus">未测试</div>
            <button class="btn btn-warning" onclick="testDeletionProcess()">测试删除流程</button>
            <button class="btn btn-danger" onclick="forceDeletion()">强制删除</button>
            <div id="deletionOutput" class="log-output" style="display: none;"></div>
        </div>
    </div>

    <!-- GitHub API 检查 -->
    <div class="diagnostic-container">
        <div class="diagnostic-section">
            <div class="diagnostic-title">🌐 GitHub API 检查</div>
            <div id="githubStatus">未检查</div>
            <button class="btn" onclick="checkGitHubAPI()">检查GitHub状态</button>
            <div id="githubOutput" class="log-output" style="display: none;"></div>
        </div>
    </div>

    <!-- 修复建议 -->
    <div class="diagnostic-container">
        <div class="diagnostic-section">
            <div class="diagnostic-title">💡 修复建议</div>
            <div id="fixSuggestions">分析中...</div>
        </div>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="js/log-manager.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/github-storage.js"></script>
    <script src="js/admin-file-manager.js"></script>
    <script src="js/data-sync-manager.js"></script>
    <script src="js/file-deletion-fix.js"></script>
    <script src="js/specific-file-deletion-fix.js"></script>

    <script>
        // 问题文件信息
        const PROBLEM_FILE = {
            fileId: '2025-08-16_work_work_1755320228871_7dh6r0uza',
            owner: '1755320228871',
            workKey: 'work_2025-08-16_work_work_1755320228871_7dh6r0uza'
        };

        function log(containerId, message) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += `[${timestamp}] ${message}\n`;
            container.scrollTop = container.scrollHeight;
            console.log(message);
        }

        function updateStatus(statusId, message, type = 'info') {
            const statusElement = document.getElementById(statusId);
            const icon = type === 'ok' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            statusElement.innerHTML = `<span class="status-indicator status-${type}"></span>${icon} ${message}`;
        }

        // 检查文件存在性
        async function checkFileExistence() {
            updateStatus('fileExistenceStatus', '检查中...', 'warning');
            log('fileExistenceOutput', '开始检查文件存在性...');

            try {
                // 1. 检查本地存储
                const localData = localStorage.getItem(PROBLEM_FILE.workKey);
                if (localData) {
                    const fileData = JSON.parse(localData);
                    log('fileExistenceOutput', `✅ 本地存储中找到文件: ${fileData.title || '无标题'}`);
                    log('fileExistenceOutput', `   - 上传时间: ${fileData.uploadTime || '未知'}`);
                    log('fileExistenceOutput', `   - 最后修改: ${fileData.lastModified || '未知'}`);
                    log('fileExistenceOutput', `   - 权限级别: ${fileData.permissions?.level || '未设置'}`);
                } else {
                    log('fileExistenceOutput', '❌ 本地存储中未找到文件');
                }

                // 2. 检查管理员文件列表
                if (window.adminFileManager && window.adminFileManager.currentFiles) {
                    const fileInList = window.adminFileManager.currentFiles.find(f => 
                        f.fileId === PROBLEM_FILE.fileId && f.owner === PROBLEM_FILE.owner
                    );
                    if (fileInList) {
                        log('fileExistenceOutput', `✅ 管理员文件列表中找到文件: ${fileInList.title || fileInList.originalName}`);
                        log('fileExistenceOutput', `   - 来源: ${fileInList.source || '未知'}`);
                        log('fileExistenceOutput', `   - 分类: ${fileInList.mainCategory}/${fileInList.subCategory}`);
                    } else {
                        log('fileExistenceOutput', '❌ 管理员文件列表中未找到文件');
                    }
                }

                // 3. 检查GitHub存储
                if (window.githubStorage && window.githubStorage.token) {
                    try {
                        const githubPath = `data/works/${PROBLEM_FILE.workKey}.json`;
                        const githubFile = await window.githubStorage.getFile(githubPath);
                        if (githubFile) {
                            log('fileExistenceOutput', `✅ GitHub存储中找到文件: ${githubPath}`);
                            log('fileExistenceOutput', `   - SHA: ${githubFile.sha.substring(0, 8)}...`);
                            log('fileExistenceOutput', `   - 大小: ${githubFile.size} bytes`);
                        }
                    } catch (error) {
                        if (error.status === 404) {
                            log('fileExistenceOutput', '❌ GitHub存储中未找到文件');
                        } else {
                            log('fileExistenceOutput', `⚠️ GitHub检查失败: ${error.message}`);
                        }
                    }
                }

                updateStatus('fileExistenceStatus', '检查完成', 'ok');
            } catch (error) {
                log('fileExistenceOutput', `❌ 检查失败: ${error.message}`);
                updateStatus('fileExistenceStatus', '检查失败', 'error');
            }
        }

        // 检查删除权限
        async function checkPermissions() {
            updateStatus('permissionStatus', '检查中...', 'warning');
            log('permissionOutput', '开始检查删除权限...');

            try {
                // 1. 检查当前用户
                if (!window.auth || !window.auth.currentUser) {
                    log('permissionOutput', '❌ 用户未登录');
                    updateStatus('permissionStatus', '用户未登录', 'error');
                    return;
                }

                log('permissionOutput', `当前用户: ${window.auth.currentUser.username}`);
                log('permissionOutput', `是否管理员: ${window.auth.isAdmin() ? '是' : '否'}`);

                // 2. 检查文件所有者权限
                const isOwner = window.auth.currentUser.username === PROBLEM_FILE.owner;
                const isAdmin = window.auth.isAdmin();
                const canDelete = isOwner || isAdmin;

                log('permissionOutput', `文件所有者: ${PROBLEM_FILE.owner}`);
                log('permissionOutput', `是否文件所有者: ${isOwner ? '是' : '否'}`);
                log('permissionOutput', `是否有删除权限: ${canDelete ? '是' : '否'}`);

                // 3. 检查管理员文件管理器权限
                if (window.adminFileManager) {
                    const canDeleteFile = window.adminFileManager.canDeleteFile(PROBLEM_FILE.owner);
                    log('permissionOutput', `管理员文件管理器权限检查: ${canDeleteFile ? '通过' : '拒绝'}`);
                }

                if (canDelete) {
                    updateStatus('permissionStatus', '权限检查通过', 'ok');
                } else {
                    updateStatus('permissionStatus', '权限不足', 'error');
                }

            } catch (error) {
                log('permissionOutput', `❌ 权限检查失败: ${error.message}`);
                updateStatus('permissionStatus', '检查失败', 'error');
            }
        }

        // 检查存储状态
        async function checkStorageStatus() {
            updateStatus('storageStatus', '检查中...', 'warning');
            log('storageOutput', '开始检查存储状态...');

            try {
                // 1. 检查本地存储可用性
                try {
                    localStorage.setItem('test_storage', 'test');
                    localStorage.removeItem('test_storage');
                    log('storageOutput', '✅ 本地存储可用');
                } catch (e) {
                    log('storageOutput', `❌ 本地存储不可用: ${e.message}`);
                }

                // 2. 检查GitHub存储状态
                if (window.githubStorage) {
                    log('storageOutput', `GitHub存储状态: ${window.githubStorage.token ? '已配置' : '未配置'}`);
                    if (window.githubStorage.token) {
                        try {
                            // 测试GitHub连接
                            const response = await fetch('https://api.github.com/repos/hysteriasy/Serial_story', {
                                headers: {
                                    'Authorization': `Bearer ${window.githubStorage.token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            });
                            log('storageOutput', `GitHub API连接: ${response.ok ? '正常' : '异常'}`);
                        } catch (error) {
                            log('storageOutput', `GitHub API连接失败: ${error.message}`);
                        }
                    }
                } else {
                    log('storageOutput', '❌ GitHub存储未初始化');
                }

                // 3. 检查数据管理器状态
                if (window.dataManager) {
                    const shouldUseGitHub = window.dataManager.shouldUseGitHubStorage();
                    log('storageOutput', `数据管理器状态: 已初始化`);
                    log('storageOutput', `应使用GitHub存储: ${shouldUseGitHub ? '是' : '否'}`);
                } else {
                    log('storageOutput', '❌ 数据管理器未初始化');
                }

                updateStatus('storageStatus', '检查完成', 'ok');
            } catch (error) {
                log('storageOutput', `❌ 存储状态检查失败: ${error.message}`);
                updateStatus('storageStatus', '检查失败', 'error');
            }
        }

        // 测试删除流程
        async function testDeletionProcess() {
            updateStatus('deletionStatus', '测试中...', 'warning');
            log('deletionOutput', '开始测试删除流程...');

            try {
                if (!window.adminFileManager) {
                    throw new Error('管理员文件管理器未初始化');
                }

                // 模拟删除确认
                const originalShowDeleteConfirmation = window.adminFileManager.showDeleteConfirmation;
                window.adminFileManager.showDeleteConfirmation = async () => {
                    log('deletionOutput', '✅ 模拟用户确认删除');
                    return true;
                };

                log('deletionOutput', '🔄 调用删除方法...');
                
                // 执行删除
                await window.adminFileManager.deleteFile(PROBLEM_FILE.fileId, PROBLEM_FILE.owner);

                // 恢复原始确认方法
                window.adminFileManager.showDeleteConfirmation = originalShowDeleteConfirmation;

                log('deletionOutput', '✅ 删除方法执行完成');

                // 检查删除结果
                setTimeout(() => {
                    checkDeletionResult();
                }, 2000);

                updateStatus('deletionStatus', '测试完成', 'ok');
            } catch (error) {
                log('deletionOutput', `❌ 删除测试失败: ${error.message}`);
                updateStatus('deletionStatus', '测试失败', 'error');
            }
        }

        // 检查删除结果
        function checkDeletionResult() {
            log('deletionOutput', '🔍 检查删除结果...');

            // 检查本地存储
            const localData = localStorage.getItem(PROBLEM_FILE.workKey);
            if (localData) {
                log('deletionOutput', '❌ 文件仍存在于本地存储中');
            } else {
                log('deletionOutput', '✅ 文件已从本地存储中删除');
            }

            // 检查文件列表
            if (window.adminFileManager && window.adminFileManager.currentFiles) {
                const fileInList = window.adminFileManager.currentFiles.find(f => 
                    f.fileId === PROBLEM_FILE.fileId && f.owner === PROBLEM_FILE.owner
                );
                if (fileInList) {
                    log('deletionOutput', '❌ 文件仍存在于管理员文件列表中');
                } else {
                    log('deletionOutput', '✅ 文件已从管理员文件列表中移除');
                }
            }
        }

        // 强制删除
        async function forceDeletion() {
            if (!confirm('确定要强制删除这个文件吗？这将从所有存储位置移除该文件。')) {
                return;
            }

            updateStatus('deletionStatus', '强制删除中...', 'warning');
            log('deletionOutput', '🔄 开始强制删除...');

            try {
                // 使用特定文件删除修复器
                if (window.specificFileDeletionFix) {
                    log('deletionOutput', '🔧 使用特定文件删除修复器...');
                    const result = await window.specificFileDeletionFix.forceDeleteSpecificFile();

                    if (result.success) {
                        log('deletionOutput', '✅ 特定文件删除修复器执行成功');
                    } else {
                        log('deletionOutput', `⚠️ 特定文件删除修复器执行失败: ${result.message}`);
                    }
                } else {
                    log('deletionOutput', '⚠️ 特定文件删除修复器不可用，使用标准方法...');

                    // 标准强制删除方法
                    // 1. 从本地存储删除
                    localStorage.removeItem(PROBLEM_FILE.workKey);
                    log('deletionOutput', '✅ 已从本地存储删除');

                    // 2. 从管理员文件列表删除
                    if (window.adminFileManager && window.adminFileManager.currentFiles) {
                        window.adminFileManager.currentFiles = window.adminFileManager.currentFiles.filter(f =>
                            !(f.fileId === PROBLEM_FILE.fileId && f.owner === PROBLEM_FILE.owner)
                        );
                        log('deletionOutput', '✅ 已从管理员文件列表删除');
                    }

                    // 3. 从GitHub删除
                    if (window.githubStorage && window.githubStorage.token) {
                        try {
                            const githubPath = `data/works/${PROBLEM_FILE.workKey}.json`;
                            await window.githubStorage.deleteFile(githubPath, `强制删除问题文件: ${PROBLEM_FILE.fileId}`);
                            log('deletionOutput', '✅ 已从GitHub存储删除');
                        } catch (error) {
                            if (error.status === 404) {
                                log('deletionOutput', 'ℹ️ GitHub中文件已不存在');
                            } else {
                                log('deletionOutput', `⚠️ GitHub删除失败: ${error.message}`);
                            }
                        }
                    }
                }

                // 4. 刷新文件列表
                if (window.adminFileManager) {
                    await window.adminFileManager.loadFileList();
                    log('deletionOutput', '✅ 已刷新文件列表');
                }

                log('deletionOutput', '🎉 强制删除完成！');
                updateStatus('deletionStatus', '强制删除成功', 'ok');

                // 再次检查删除结果
                setTimeout(() => {
                    checkDeletionResult();
                }, 2000);

            } catch (error) {
                log('deletionOutput', `❌ 强制删除失败: ${error.message}`);
                updateStatus('deletionStatus', '强制删除失败', 'error');
            }
        }

        // 检查GitHub API
        async function checkGitHubAPI() {
            updateStatus('githubStatus', '检查中...', 'warning');
            log('githubOutput', '开始检查GitHub API...');

            try {
                if (!window.githubStorage || !window.githubStorage.token) {
                    log('githubOutput', '❌ GitHub存储未配置');
                    updateStatus('githubStatus', 'GitHub未配置', 'error');
                    return;
                }

                // 检查仓库访问权限
                const repoResponse = await fetch('https://api.github.com/repos/hysteriasy/Serial_story', {
                    headers: {
                        'Authorization': `Bearer ${window.githubStorage.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (repoResponse.ok) {
                    log('githubOutput', '✅ 仓库访问正常');
                } else {
                    log('githubOutput', `❌ 仓库访问失败: ${repoResponse.status}`);
                }

                // 检查文件是否存在于GitHub
                try {
                    const filePath = `data/works/${PROBLEM_FILE.workKey}.json`;
                    const fileResponse = await fetch(`https://api.github.com/repos/hysteriasy/Serial_story/contents/${filePath}`, {
                        headers: {
                            'Authorization': `Bearer ${window.githubStorage.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (fileResponse.ok) {
                        const fileData = await fileResponse.json();
                        log('githubOutput', `✅ 文件存在于GitHub: ${filePath}`);
                        log('githubOutput', `   - SHA: ${fileData.sha}`);
                        log('githubOutput', `   - 大小: ${fileData.size} bytes`);
                    } else if (fileResponse.status === 404) {
                        log('githubOutput', `ℹ️ 文件不存在于GitHub: ${filePath}`);
                    } else {
                        log('githubOutput', `⚠️ 检查GitHub文件失败: ${fileResponse.status}`);
                    }
                } catch (error) {
                    log('githubOutput', `❌ GitHub文件检查异常: ${error.message}`);
                }

                updateStatus('githubStatus', '检查完成', 'ok');
            } catch (error) {
                log('githubOutput', `❌ GitHub API检查失败: ${error.message}`);
                updateStatus('githubStatus', '检查失败', 'error');
            }
        }

        // 页面加载完成后自动执行基础检查
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkFileExistence();
                checkPermissions();
                checkStorageStatus();
            }, 2000);
        });
    </script>
</body>
</html>
